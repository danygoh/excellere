# Excellere Credential System - Database & Authentication Design

## Database: Supabase (PostgreSQL)

### Tables

#### 1. users
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email TEXT UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,
  first_name TEXT NOT NULL,
  last_name TEXT NOT NULL,
  role TEXT NOT NULL CHECK (role IN ('learner', 'validator', 'admin')),
  
  -- Learner specific
  organisation TEXT,
  sector TEXT,
  job_title TEXT,
  
  -- Validator specific  
  title TEXT,
  institution TEXT,
  bio TEXT,
  photo_url TEXT,
  
  -- Status
  is_active BOOLEAN DEFAULT true,
  email_verified BOOLEAN DEFAULT false,
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### 2. learner_profiles
```sql
CREATE TABLE learner_profiles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  
  -- Cognitive dimensions (0-100)
  strategic_vs_operational INTEGER DEFAULT 50,
  conceptual_vs_technical INTEGER DEFAULT 50,
  single_vs_double_loop INTEGER DEFAULT 50,
  challenge_vs_confirmation INTEGER DEFAULT 50,
  
  -- Computed
  archetype TEXT,
  archetype_description TEXT,
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### 3. modules
```sql
CREATE TABLE modules (
  id TEXT PRIMARY KEY, -- e.g., 'ai-native-business-design'
  name TEXT NOT NULL,
  description TEXT,
  order_index INTEGER NOT NULL,
  is_active BOOLEAN DEFAULT true
);
```

#### 4. learner_modules (progress tracking)
```sql
CREATE TABLE learner_modules (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  module_id TEXT REFERENCES modules(id),
  
  status TEXT DEFAULT 'not_started', -- not_started, in_progress, completed
  progress_percent INTEGER DEFAULT 0,
  
  started_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,
  
  UNIQUE(user_id, module_id)
);
```

#### 5. sessions
```sql
CREATE TABLE sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  module_id TEXT REFERENCES modules(id),
  session_number INTEGER NOT NULL,
  
  -- Content
  topic TEXT NOT NULL,
  teach_back_response TEXT,
  ai_analysis JSONB,
  
  completed BOOLEAN DEFAULT false,
  completed_at TIMESTAMPTZ,
  
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### 6. artefacts
```sql
CREATE TABLE artefacts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  module_id TEXT REFERENCES modules(id),
  
  title TEXT NOT NULL,
  content JSONB,
  type TEXT,
  status TEXT DEFAULT 'draft', -- draft, submitted, validated
  
  strength_scores JSONB,
  board_readiness INTEGER,
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### 7. insight_reports (generated by Aria)
```sql
CREATE TABLE insight_reports (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  module_id TEXT NOT NULL,
  
  -- Claude-generated content
  report_content JSONB NOT NULL,
  
  -- Scores
  overall_score INTEGER,
  mastery_percentage INTEGER,
  
  -- Badges
  badges_earned JSONB DEFAULT '[]',
  
  -- Sharing
  share_slug TEXT UNIQUE,
  is_public BOOLEAN DEFAULT false,
  share_enabled_at TIMESTAMPTZ,
  view_count INTEGER DEFAULT 0,
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### 8. validators
```sql
CREATE TABLE validators (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE SET NULL,
  
  name TEXT NOT NULL,
  title TEXT NOT NULL,
  institution TEXT NOT NULL,
  bio TEXT,
  photo_url TEXT,
  email TEXT UNIQUE NOT NULL,
  is_active BOOLEAN DEFAULT true,
  
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### 9. validation_queue
```sql
CREATE TABLE validation_queue (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  report_id UUID REFERENCES insight_reports(id) ON DELETE CASCADE,
  validator_id UUID REFERENCES validators(id),
  
  status TEXT DEFAULT 'queued', -- queued, opened, validated, rejected
  validator_notes TEXT,
  validator_comment TEXT, -- Human-written, appears on credential
  
  score_override INTEGER,
  assessment TEXT, -- validated, needs_revision, exceptional
  
  assigned_at TIMESTAMPTZ DEFAULT NOW(),
  opened_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ
);
```

#### 10. credentials (full programme)
```sql
CREATE TABLE credentials (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  
  credential_slug TEXT UNIQUE NOT NULL,
  
  -- Content
  capability_statement TEXT NOT NULL,
  
  -- Validation
  validator_id UUID REFERENCES validators(id),
  validator_comment TEXT,
  validated_at TIMESTAMPTZ,
  
  -- Status
  status TEXT DEFAULT 'draft', -- draft, issued, public
  
  -- Analytics
  view_count INTEGER DEFAULT 0,
  last_viewed_at TIMESTAMPTZ,
  
  issued_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## Authentication Flow

### 1. Learner Flow
```
1. Visit /signup
2. Enter: name, email, password, organisation, job_title
3. System creates user + learner_profile
4. Email verification (optional for demo)
5. Redirect to /dashboard
6. Enroll in first module
7. Complete sessions â†’ Report auto-generated
8. Report queued for validation
9. Receive credential when validated
```

### 2. Validator Flow
```
1. Admin creates validator account (or invited)
2. Visit /login
3. Enter email + password
4. Redirect to /validate
5. View pending reports queue
6. Select report to review
7. Read learner context + Aria's report
8. Write personal comment (required)
9. Sign & Issue
10. Learner notified
```

### 3. Admin Flow
```
1. Visit /admin (protected)
2. View all learners, reports, credentials
3. Manage validators
4. View analytics
5. Manage modules
```

---

## API Endpoints

### Auth
- `POST /api/auth/signup` - Learner registration
- `POST /api/auth/login` - Login
- `POST /api/auth/logout` - Logout
- `GET /api/auth/me` - Get current user

### Learners
- `GET /api/learner/dashboard` - Get dashboard data
- `GET /api/learner/modules` - List available modules
- `GET /api/learner/progress` - Get progress
- `POST /api/learner/complete-session` - Submit session

### Reports
- `GET /api/reports` - My reports
- `GET /api/reports/:id` - Get report
- `POST /api/reports/:id/publish` - Make public

### Validators
- `GET /api/validate/queue` - Get pending queue
- `GET /api/validate/:id` - Get report to review
- `POST /api/validate/:id` - Submit validation

### Admin
- `GET /api/admin/learners` - All learners
- `GET /api/admin/validators` - All validators
- `POST /api/admin/validators` - Create validator
